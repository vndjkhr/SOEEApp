@model SOEEApp.Models.ViewModels.SOEECreateViewModel

@{
    ViewBag.Title = "Create SOEE";
}

<h2>Create SOEE</h2>

@using (Html.BeginForm("Create", "SOEE", FormMethod.Post))
{
    @Html.AntiForgeryToken()

    <div class="row">

        <div class="col-md-4">
            @Html.LabelFor(m => m.ProjectID)
            @Html.DropDownListFor(
                m => m.ProjectID,
                ViewBag.Projects as SelectList,
                "Select Project",
                new { @class = "form-control", id = "projectSelect" }
            )
        </div>

        <div class="col-md-4">
            @Html.LabelFor(m => m.CustomerID)
            @Html.DropDownListFor(
                m => m.CustomerID,
                ViewBag.Customers as SelectList,
                "Select Customer",
                new { @class = "form-control" }
            )
        </div>

        <div class="col-md-4">
            @Html.LabelFor(m => m.ReferenceNo)
            @Html.TextBoxFor(m => m.ReferenceNo, new { @class = "form-control" })
        </div>

    </div>

    <br />

    <div class="row">
        <div class="col-md-4">
            @Html.LabelFor(m => m.MarkTo)
            @Html.TextBoxFor(m => m.MarkTo, new { @class = "form-control" })
        </div>

        <div class="col-md-4">
            @Html.LabelFor(m => m.Subject)
            @Html.TextBoxFor(m => m.Subject, new { @class = "form-control" })
        </div>

        <div class="col-md-4">
            @Html.LabelFor(m => m.Reference)
            @Html.TextBoxFor(m => m.Reference, new { @class = "form-control" })
        </div>
    </div>

    <br />

    <div class="row">
        <div class="col-md-4">
            @Html.LabelFor(m => m.SOEERaiseDate, "SOEE Raised Date")
            @Html.TextBoxFor(m => m.SOEERaiseDate, new { @class = "form-control", type = "date" })
        </div>

        <div class="col-md-4">
            @Html.LabelFor(m => m.Content)
            @Html.TextBoxFor(m => m.Content, new { @class = "form-control" })
        </div>

        <div class="form-group">
            @Html.LabelFor(m => m.Status)
            @Html.EnumDropDownListFor(m => m.Status, new { @class = "form-control" })
        </div>
    </div>

    <hr />

    <h4>Service Entry Items</h4>
    <button type="button" id="addRow" class="btn btn-primary">Add Service Item</button><br><br>

    <table class="table table-bordered" id="serviceTable">
        <thead>
            <tr>
                <th>Description of Work</th>
                <th>Service Type</th>
                <th>Unit</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Subtotal</th>
                <th>Service Charge %</th>
                <th>Service Charges</th>
                <th>Total After Service Charge</th>
                <th>CGST</th>
                <th>SGST</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>

        <tbody id="serviceBody"></tbody>
    </table>

    <hr />

    <div class="row">
        <div class="col-md-3">
            <label>Total Basic</label>
            <input type="text" id="TotalBasicAmount" class="form-control" readonly />
        </div>

        <div class="col-md-3">
            <label>Total Service Charges</label>
            <input type="text" id="TotalServiceCharge" class="form-control" readonly />
        </div>

        <div class="col-md-3">
            <label>Total Tax Amount</label>
            <input type="text" id="TotalTaxAmount" class="form-control" readonly />
        </div>

        <div class="col-md-3">
            <label>Grand Total</label>
            <input type="text" id="GrandTotal" class="form-control" readonly />
        </div>
    </div>
    <br>

    <button type="submit" class="btn btn-success">Save SOEE</button>
    <a href="@Url.Action("Index", "SOEE")" class="btn btn-default">Cancel</a>
}

@section Scripts {
    <script>

    // Generate unique row index
    function generateId() {
        return 'id' + Date.now() + Math.floor(Math.random() * 1000);
    }

    // Build row HTML
    function newRow(uid) {
        return `
        <tr>
            <input type="hidden" name="Items.index" value="${uid}" />

            <td>
                <input type="text" name="Items[${uid}].DescriptionOfWork" class="form-control" required />
            </td>

            <td>
                <select name="Items[${uid}].ServiceTypeID" class="form-control">
                    @foreach (var s in ViewBag.ServiceTypes as List<SOEEApp.Models.ServiceType>)
                    {
                        <option value="@s.ServiceTypeID">@s.ServiceName</option>
                    }
                </select>
            </td>

            <td><input type="number" step="1" name="Items[${uid}].Unit" class="form-control unit" /></td>
            <td><input type="number" step="1" name="Items[${uid}].Quantity" class="form-control qty" /></td>
            <td><input type="number" step="1" name="Items[${uid}].UnitPrice" class="form-control UnitPrice" /></td>

            <td><input type="text" name="Items[${uid}].SubTotal" class="form-control SubTotal" readonly /></td>

            <!-- HIDDEN REAL VALUE -->
            <input type="hidden" name="Items[${uid}].ServiceChargePercent" class="servicechargepercent_val" />

            <!-- VISIBLE FIELD (NOT POSTED) -->
            <td><input type="text" class="form-control servicechargepercent" readonly /></td>

            <td><input type="text" name="Items[${uid}].ServiceCharge" class="form-control servicecharge" readonly /></td>
            <td><input type="text" name="Items[${uid}].TotalAfterServiceCharge" class="form-control totalafterservicecharge" readonly /></td>
            <td><input type="text" name="Items[${uid}].CGST" class="form-control cgst" readonly /></td>
            <td><input type="text" name="Items[${uid}].SGST" class="form-control sgst" readonly /></td>
            <td><input type="text" name="Items[${uid}].Total" class="form-control total" readonly /></td>

            <td><button type="button" class="btn btn-danger removeRow">X</button></td>
        </tr>
        `;
    }

    // Add row
    $("#addRow").click(function () {
        const id = generateId();
        $("#serviceBody").append(newRow(id));
    });

    // Remove row
    $(document).on("click", ".removeRow", function () {
        $(this).closest("tr").remove();
        updateSOEETotals();
    });

    // CALCULATIONS
    function calculateRow(row) {

        const unit = parseFloat(row.find(".unit").val()) || 0;
        const qty = parseFloat(row.find(".qty").val()) || 0;
        const UnitPrice = parseFloat(row.find(".UnitPrice").val()) || 0;

        const subtotal = unit * qty * UnitPrice;
        row.find(".SubTotal").val(subtotal.toFixed(2));

        const serviceTypeId = row.find("select[name*='.ServiceTypeID']").val();
        const projectId = $("#projectSelect").val();

        if (serviceTypeId && projectId && subtotal > 0) {

            $.ajax({
                url: '@Url.Action("GetServiceChargePercent", "SOEE")',
                method: "POST",
                data: { serviceTypeId, subtotal, projectId },
                success: function (data) {

                    const percent = data.percentage;

                    // Store REAL numeric data
                    row.find(".servicechargepercent_val").val(percent);

                    // Show visible text
                    row.find(".servicechargepercent").val(percent + "%");

                    const serviceCharge = subtotal * (percent / 100);
                    const after = subtotal + serviceCharge;
                    const cgst = after * 0.09;
                    const sgst = after * 0.09;
                    const total = subtotal + serviceCharge + cgst + sgst;

                    row.find(".servicecharge").val(serviceCharge.toFixed(2));
                    row.find(".totalafterservicecharge").val(after.toFixed(2));
                    row.find(".cgst").val(cgst.toFixed(2));
                    row.find(".sgst").val(sgst.toFixed(2));
                    row.find(".total").val(total.toFixed(2));

                    updateSOEETotals();
                }
            });

        } else {
            row.find(".servicechargepercent").val("");
            row.find(".servicechargepercent_val").val("");
        }
    }

    $(document).on("input", ".unit, .qty, .UnitPrice", function () {
        calculateRow($(this).closest("tr"));
    });

    $(document).on("change", "select[name*='.ServiceTypeID']", function () {
        calculateRow($(this).closest("tr"));
    });

    $("#projectSelect").change(function () {
        $("#serviceBody tr").each(function () {
            calculateRow($(this));
        });
        updateSOEETotals();
    });

    function updateSOEETotals() {
        let basic = 0, serviceCharge = 0, cgst = 0, sgst = 0, total = 0;

        $("#serviceBody tr").each(function () {
            basic += parseFloat($(this).find(".SubTotal").val()) || 0;
            serviceCharge += parseFloat($(this).find(".servicecharge").val()) || 0;
            cgst += parseFloat($(this).find(".cgst").val()) || 0;
            sgst += parseFloat($(this).find(".sgst").val()) || 0;
            total += parseFloat($(this).find(".total").val()) || 0;
        });

        $("#TotalBasicAmount").val(basic.toFixed(2));
        $("#TotalServiceCharge").val(serviceCharge.toFixed(2));
        $("#TotalTaxAmount").val((cgst + sgst).toFixed(2));
        $("#GrandTotal").val(total.toFixed(2));
    }

    </script>
}
